<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Fr0zen的博客</title>
  <meta name="author" content="Fr0zen">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Fr0zen的博客"/>

  
    <meta property="og:image" content=""/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Fr0zen的博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  <header id="header"><div class="meta inner">
  <h1><a href="/">Fr0zen的博客</a></h1>
  <h2><a href="/">Fr0zen</a></h2>
  <nav id="main-nav">
    <ul>
      
      <li><a href="/archives">Archives</a></li>
      
    </ul>
    <div class="clearfix"></div>
  </nav>
</div>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2024/12/15/大型项目预览卡顿解决方案/">大型项目预览卡顿解决方案</a></h1>
  

      
        <time datetime="2024-12-14T16:00:00.000Z">2024-12-15</time>
      
    </header>
    <div class="entry">
      
        <h1 id="大型项目预览卡顿原因"><a href="#大型项目预览卡顿原因" class="headerlink" title="大型项目预览卡顿原因"></a>大型项目预览卡顿原因</h1><p>在浏览器预览时，调用loadBundle去加载bundle，主要要获得两个文件：config.json和index.js，分别是资源映射和代码。熟悉构建流程的话，会对这两个文件很熟悉，构建后的bundle目录下就包含这两个文件。因此猜想，在预览时请求bundle，引擎会动态构建对应的bundle（由于编辑器不开源，根据实际情况推断，这个构建不是完全构建，可能只是部分构建）。bundle的文件数量越多，动态构建的耗时越长，预览时等待的时间也越长。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><ol>
<li>拆分项目为一个主项目和多个子项目，子项目中包含多个bundle。</li>
<li>构建所有子项目。</li>
<li>在主项目中启动游戏，加载子项目中的bundle时，修改路径为本地构建好的bundle。</li>
</ol>
<h1 id="技术原理"><a href="#技术原理" class="headerlink" title="技术原理"></a>技术原理</h1><h2 id="Asset-Bundle支持跨项目"><a href="#Asset-Bundle支持跨项目" class="headerlink" title="Asset Bundle支持跨项目"></a><strong>Asset Bundle</strong>支持跨项目</h2><p>cocos creator2.4推出了 <a target="_blank" rel="noopener" href="https://docs.cocos.com/creator/2.4/manual/zh/scripting/asset-bundle.html"><strong>Asset Bundle</strong></a> 功能，支持 <strong>代码</strong>、<strong>资源</strong> 和 <strong>场景</strong> 的分包加载。<br>支持加载远程<strong>Asset Bundle</strong>，也支持加载本地<strong>Asset Bundle</strong></p>
<img src="/2024/12/15/%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE%E9%A2%84%E8%A7%88%E5%8D%A1%E9%A1%BF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E5%BC%95%E6%93%8E%E5%8A%A0%E8%BD%BDbundle.png" class="" title="引擎加载bundle">
<p>基于这个特性，我们可以预先构建一些bundle，在预览时直接使用构建好的bundle，这样每次重新预览时就不需要再等引擎动态构建。</p>
<h2 id="Aswallow插件"><a href="#Aswallow插件" class="headerlink" title="Aswallow插件"></a>Aswallow插件</h2><img src="/2024/12/15/%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE%E9%A2%84%E8%A7%88%E5%8D%A1%E9%A1%BF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E7%BC%96%E8%BE%91%E5%99%A8%E9%A2%84%E8%A7%88%E6%9C%8D%E5%8A%A1%E5%99%A8.png" class="" title="编辑器预览服务器">
<p>引擎编辑器内部有个预览服务器，用inspect在控制台打印可以看到，<code>userMiddlewares</code>是个函数数组，通过命名可以看出是个自定义的中间件，实际调试也发现如此。通过在<code>userMiddlewares</code>添加函数，来篡改预览服务器返回资源的逻辑。基于引擎预览服务器的特性，社区大佬开发了<a target="_blank" rel="noopener" href="https://forum.cocos.org/t/topic/115111">Aswallow插件</a>，可以通过配置的方式方便地访问项目外的bundle，特别说明：可以是已构建后的bundle，也可以是本地启动的另一个项目的bundle。</p>
<h1 id="项目实际案例"><a href="#项目实际案例" class="headerlink" title="项目实际案例"></a>项目实际案例</h1><p>性能分析预览卡顿的最大耗时在动态构建silence_texture上，大概要等1分钟才能构建完成，所以将silence_texture拆分出来。</p>
<img src="/2024/12/15/%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE%E9%A2%84%E8%A7%88%E5%8D%A1%E9%A1%BF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/3x%E5%8A%A0%E8%BD%BDsilence_texture%E5%8D%A1%E9%A1%BF.png" class="" title="3x加载silence_texture卡顿">
<h2 id="项目拆分目录"><a href="#项目拆分目录" class="headerlink" title="项目拆分目录"></a>项目拆分目录</h2><img src="/2024/12/15/%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE%E9%A2%84%E8%A7%88%E5%8D%A1%E9%A1%BF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/3x%E9%A1%B9%E7%9B%AE%E6%8B%86%E5%88%86%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png" class="" title="3x项目拆分目录结构">
<p>将silence_texture文件夹单独提出来拆分成子项目，resources和代码暂时不做拆分，因为prefab直接引用了很多组件，不方便拆分。</p>
<h2 id="与原项目同步"><a href="#与原项目同步" class="headerlink" title="与原项目同步"></a>与原项目同步</h2><p>一般通过合并的方式同步原项目和拆分后项目。<br>如果原项目和拆分项目完全一致，可以使用svn外链来同步-[[SVN外链-共享仓库目录的方式]]</p>
<img src="/2024/12/15/%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE%E9%A2%84%E8%A7%88%E5%8D%A1%E9%A1%BF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/%E5%A4%96%E9%93%BE%E7%A4%BA%E6%84%8F.png" class="" title="外链示意">
<h2 id="bundle加载修改"><a href="#bundle加载修改" class="headerlink" title="bundle加载修改"></a>bundle加载修改</h2><p>修改loadBundle，加载silence_texture时使用构建后的路径，加入<strong>PREVIEW_BUNDLE_LOAD_PROTOCOL</strong>前缀，用于在预览服务器中识别。详细实现方案看代码。</p>
<img src="/2024/12/15/%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE%E9%A2%84%E8%A7%88%E5%8D%A1%E9%A1%BF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/bundle%E8%B7%AF%E5%BE%84%E4%BF%AE%E6%94%B9.png" class="" title="bundle路径修改">
<h2 id="耗时对比"><a href="#耗时对比" class="headerlink" title="耗时对比"></a>耗时对比</h2><p>实际构建silence_texture子项目每次耗时5分钟，而不拆分项目每次预览时动态构建silence_texture耗时1分钟。拆分项目后，最大耗时在加载resources，大概4秒多，总耗时10秒左右。因为在拆分项目后，silence_texture有变化就需要重新构建，把这部分耗时也计算在内，分为四种情况对比耗时。</p>
<table>
  <tr>
    <th style="width: 40%;">预览情况</th>
    <th style="width: 20%;">原项目</th>
    <th style="width: 20%;">拆分项目</th>
  </tr>
  <tr>
    <td>silence_texture无变化预览1次</td>
    <td>1分钟</td>
    <td>10秒</td>
  </tr>
  <tr>
    <td>silence_texture无变化预览n次</td>
    <td>1分钟*n</td>
    <td>10秒*n</td>
  </tr>
  <tr>
    <td>silence_texture变化后预览1次</td>
    <td>1分钟</td>
    <td>5分钟+10秒</td>
  </tr>
  <tr>
    <td>silence_texture变化后预览n次</td>
    <td>1分钟*n</td>
    <td>5分钟+10秒*n</td>
  </tr>
</table>
容易发现，当silence_texture变化频率不高时，拆分项目是正收益。
对于**开发**来说，因为silence_texture本来就是动态加载的资源，即使缺少资源在通常情况下并不会卡流程，不会影响当前开发的功能，所以有时候不重新构建也不会有影响，本地silence_texture变化频率相对可以变低。
对于**测试**来说，可能不一定是正收益。因为测试不会频繁修改代码，刷新预览的次数也不多，反而每次silence_texture有变化都一定要重新构建。如果silence_texture变化频率高，会是负收益。

<p>个人认为，重新预览要等待一分钟十分难以忍受，即使只修改了一行代码，也要等一分钟才能看到效果，<strong>极其影响编码的节奏</strong>。<br>采用拆分项目后，在日常开发流程中，每天开始工作时，基本上只需要构建一次silence_texture，就可以<strong>干掉今天每次预览时需要等待的一分钟</strong>。</p>
<p>还有一点，主项目相比于原项目少了silence_texture，项目文件少了很多，所以切换回引擎编辑器窗口的卡顿耗时也会降低，这部分耗时不好量化，个人感觉流畅很多。</p>
<h2 id="构建发布"><a href="#构建发布" class="headerlink" title="构建发布"></a>构建发布</h2><p>Aswallow插件支持处理拆分项目后复杂的构建流程，能将多个子项目整合，构建成同一个项目。</p>

      
    </div>
      
        
        
      
      <div class="clearfix"></div>
      </footer>
  </div>
</article>





  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2024/08/08/Label合图/">Label合图</a></h1>
  

      
        <time datetime="2024-08-07T16:00:00.000Z">2024-08-08</time>
      
    </header>
    <div class="entry">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>众所周知，cocos的label性能很烂。特别是ttf字体的label，在生成字符串位图时耗时太高，甚至于加载prefab的主要耗时都在label上。两种缓存模式各有坑，BITMAP有bug会重复两个位图，char用满了图集不会回收，而且有描边时显示很怪。<br>所以做了label合图优化。社区大佬提供的方案是修改char模式，合理重复利用图集空间，详情见<a target="_blank" rel="noopener" href="https://forum.cocos.org/t/label-2-char/97766">乐府的文章</a>。但是char模式对于描边、阴影显示效果不好，于是改进方案：直接将位图打进合图。</p>
<h2 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a>技术方案</h2><img src="/2024/08/08/Label%E5%90%88%E5%9B%BE/Label%E5%90%88%E5%9B%BE%E6%B5%81%E7%A8%8B%E5%9B%BE.png" class="" title="Label合图流程图">

<h3 id="核心逻辑"><a href="#核心逻辑" class="headerlink" title="核心逻辑"></a>核心逻辑</h3><p>仿照<code>cc.dynamicAtlasManager</code>，自定义缓存图集<code>cacheAtlasManager</code>，图集使用MaxRects算法管理空间。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//缓存图集cacheAtlas</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Atlas</span>(<span class="params">width, height, manager</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">manager</span> = manager;</span><br><span class="line">    <span class="keyword">let</span> texture = <span class="keyword">new</span> <span class="title class_">RenderTexture</span>();</span><br><span class="line">    texture.<span class="title function_">initWithSize</span>(width, height);</span><br><span class="line">    texture.<span class="title function_">update</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_texture</span> = texture;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maxSize</span> = width * height * <span class="number">4</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maxAutoReleaseSize</span> = <span class="variable language_">this</span>.<span class="property">maxSize</span> * <span class="number">0.85</span>; <span class="comment">// 图片排列并不规则，剩余空间会很零碎，所以这里尽量低些</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maxHoldSize</span> = <span class="variable language_">this</span>.<span class="property">maxSize</span> * <span class="number">0.5</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">releaseSizeOnce</span> = <span class="variable language_">this</span>.<span class="property">maxSize</span> * <span class="number">0.3</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">curSize</span> = <span class="number">0</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_x</span> = space;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_y</span> = space;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_nexty</span> = space;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_width</span> = width;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_height</span> = height;</span><br><span class="line">	<span class="comment">//使用MaxRects算法管理空间</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_maxRects</span> = <span class="keyword">new</span> <span class="title class_">MaxRects</span>(<span class="variable language_">this</span>.<span class="property">_width</span>, <span class="variable language_">this</span>.<span class="property">_height</span>, space, space);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_innerSpriteFrames</span> = [];</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_cacheInfoList</span> = [];</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_cacheInfoMap</span> = &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ttf更新逻辑修改，拓展<code>_updateRenderData</code>，判断缓存图集</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ttf.js</span></span><br><span class="line"><span class="comment">//修改updateRenderData</span></span><br><span class="line"><span class="title function_">_updateRenderDataByCacheAtlas</span>(<span class="params">comp</span>) &#123;</span><br><span class="line">	<span class="comment">//缓存UId</span></span><br><span class="line">    <span class="keyword">let</span> newCacheUId = <span class="string">`c: <span class="subst">$&#123;_string&#125;</span>_<span class="subst">$&#123;_fontSize&#125;</span>_<span class="subst">$&#123;_underlineThickness&#125;</span>_<span class="subst">$&#123;_overflow&#125;</span>_<span class="subst">$&#123;_canvasSize.width&#125;</span>_<span class="subst">$&#123;_canvasSize.height</span></span></span><br><span class="line"><span class="subst"><span class="string">    &#125;</span>_<span class="subst">$&#123;_nodeContentSize.width&#125;</span>_<span class="subst">$&#123;_nodeContentSize.height&#125;</span>_<span class="subst">$&#123;_lineHeight&#125;</span>_<span class="subst">$&#123;_hAlign&#125;</span>_<span class="subst">$&#123;_vAlign&#125;</span>_<span class="subst">$&#123;_color._val&#125;</span>_<span class="subst">$&#123;_enableBold</span></span></span><br><span class="line"><span class="subst"><span class="string">    &#125;</span>_<span class="subst">$&#123;_enableItalic&#125;</span>_<span class="subst">$&#123;_enableUnderline&#125;</span>_<span class="subst">$&#123;_fontFamily&#125;</span>_<span class="subst">$&#123;_premultiply&#125;</span>_<span class="subst">$&#123;_outlineComp &amp;&amp; _outlineColor._val || <span class="number">0</span></span></span></span><br><span class="line"><span class="subst"><span class="string">    &#125;</span>_<span class="subst">$&#123;_shadowComp &amp;&amp; _shadowColor._val || <span class="number">0</span>&#125;</span>_<span class="subst">$&#123;comp.cacheMode&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">let</span> cachedInfo = <span class="variable language_">this</span>.<span class="title function_">getCacheInfoByUId</span>(newCacheUId);</span><br><span class="line">    <span class="keyword">if</span> (cachedInfo) &#123;</span><br><span class="line">        _texture.<span class="property">width</span> = cachedInfo.<span class="property">width</span>;</span><br><span class="line">        _texture.<span class="property">height</span> = cachedInfo.<span class="property">height</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_calCacheAtlas</span>(comp, cachedInfo);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_updateLabelDimensions</span>();</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_updateTexture</span>(comp);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_calCacheAtlas</span>(comp, <span class="literal">undefined</span>, newCacheUId);</span><br><span class="line">        cachedInfo = <span class="variable language_">this</span>.<span class="title function_">getCacheInfoByUId</span>(newCacheUId);</span><br><span class="line">        <span class="keyword">if</span> (!cachedInfo) &#123;</span><br><span class="line">            _texture.<span class="title function_">handleLoadedTexture</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//计算缓存图集</span></span><br><span class="line"><span class="title function_">_calCacheAtlas</span> (comp, cachedInfo, uid) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable language_">this</span>.<span class="title function_">isCacheAtlasEnabled</span>()) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">let</span> frame = comp.<span class="property">_frame</span>;</span><br><span class="line">    <span class="title function_">deleteFromCacheAtlas</span>(comp, frame);</span><br><span class="line">    <span class="keyword">if</span> (cachedInfo) &#123;</span><br><span class="line">        frame.<span class="title function_">setRect</span>(cc.<span class="title function_">rect</span>(<span class="number">0</span>, <span class="number">0</span>, cachedInfo.<span class="property">width</span>, cachedInfo.<span class="property">height</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        frame.<span class="title function_">setRect</span>(cc.<span class="title function_">rect</span>(<span class="number">0</span>, <span class="number">0</span>, _canvas.<span class="property">width</span>, _canvas.<span class="property">height</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(uid)&#123;</span><br><span class="line">        frame.<span class="property">_texture</span>.<span class="property">_cacheUId</span> = uid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">packToCacheAtlas</span>(comp, frame);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MaxRects空间算法"><a href="#MaxRects空间算法" class="headerlink" title="MaxRects空间算法"></a>MaxRects空间算法</h3><p>使用MaxRects算法管理空间，大致逻辑如下：</p>
<ul>
<li>维护“空闲矩形列表”。初始时，整张图片作为一个空闲矩形</li>
<li>若要放入一张图片，则在“空闲矩形列表”中寻找，找到一个合适的矩形，并从“空闲矩形列表”移除</li>
<li>把找到的矩形拆分为一个或多个矩形，其中一个正好容纳图片。剩余的矩形加入“空闲矩形列表”之中</li>
</ul>
<h4 id="取用逻辑"><a href="#取用逻辑" class="headerlink" title="取用逻辑"></a>取用逻辑</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">placeRect</span>(<span class="params">rect</span>) &#123;</span><br><span class="line">	<span class="comment">//查询合适的矩形</span></span><br><span class="line">    <span class="keyword">let</span> node = <span class="variable language_">this</span>.<span class="title function_">findNode</span>(rect.<span class="property">width</span> + <span class="variable language_">this</span>.<span class="property">padding</span>, rect.<span class="property">height</span> + <span class="variable language_">this</span>.<span class="property">padding</span>)</span><br><span class="line">    <span class="keyword">if</span> (node) &#123;</span><br><span class="line">	    <span class="comment">//更新其他自由矩形</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">spliceAllFreeRect</span>(node)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">pruneFreeList</span>()</span><br><span class="line">        rect.<span class="property">x</span> = node.<span class="property">x</span>;</span><br><span class="line">        rect.<span class="property">y</span> = node.<span class="property">y</span>;</span><br><span class="line">        <span class="comment">//记录缓存</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">recycleRect</span>(node);</span><br><span class="line">        <span class="keyword">return</span> rect;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="回收逻辑"><a href="#回收逻辑" class="headerlink" title="回收逻辑"></a>回收逻辑</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">batchRelease</span>(<span class="params">rectList, rectMap</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (rectList.<span class="property">length</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!rectMap) &#123;</span><br><span class="line">        rectMap = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; rectList.<span class="property">length</span>; index++) &#123;</span><br><span class="line">            <span class="keyword">let</span> rect = rectList[index];</span><br><span class="line">            rectMap[rect.<span class="title function_">getUid</span>()] = rect;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> newRects = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; <span class="variable language_">this</span>.<span class="property">rects</span>.<span class="property">length</span>; index++) &#123;</span><br><span class="line">        <span class="keyword">let</span> usedRect = <span class="variable language_">this</span>.<span class="property">rects</span>[index];</span><br><span class="line">        <span class="keyword">if</span> (!rectMap[usedRect.<span class="title function_">getUid</span>()]) &#123;</span><br><span class="line">            newRects.<span class="title function_">push</span>(usedRect);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//更新已使用的矩形</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">rects</span> = newRects;</span><br><span class="line">    <span class="comment">//选择不同回收策略</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">rects</span>.<span class="property">length</span> &gt; <span class="variable language_">this</span>.<span class="property">resetHoldNum</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_batchReleaseByExpand</span>(rectList);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_batchReleaseByReset</span>(rectList);</span><br><span class="line">    &#125;        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>空间利用展示</p>
<img src="/2024/08/08/Label%E5%90%88%E5%9B%BE/%E7%A9%BA%E9%97%B4%E5%88%A9%E7%94%A8%E5%B1%95%E7%A4%BA.png" class="" title="空间利用展示.png">
<h2 id="用例场景"><a href="#用例场景" class="headerlink" title="用例场景"></a>用例场景</h2><p>和动态合图一样，Label合图不能无脑用。合图的思路是用空间换时间，但是如果渲染的Label不在同一批次，耗时反而会增加，因为每次渲染提交的texture都是大图。<br>需要调整节点结构，使Label能够集中渲染：</p>
<ol>
<li>列表结构，使用[[层序渲染]]</li>
<li>自定义渲染流，使Label最后统一渲染（因为一般情况同界面内的Label都不应该被遮挡）</li>
</ol>

      
    </div>
      
        
        
      
      <div class="clearfix"></div>
      </footer>
  </div>
</article>





  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2024/06/06/自定义渲染流程/">自定义渲染流程</a></h1>
  

      
        <time datetime="2024-06-05T16:00:00.000Z">2024-06-06</time>
      
    </header>
    <div class="entry">
      
        <h1 id="cocos-渲染流程"><a href="#cocos-渲染流程" class="headerlink" title="cocos 渲染流程"></a>cocos 渲染流程</h1><h2 id="渲染流-RenderFlow"><a href="#渲染流-RenderFlow" class="headerlink" title="渲染流 RenderFlow"></a>渲染流 RenderFlow</h2><p>2.x 中 cocos 引擎的渲染流程是通过渲染流（RenderFlow）实现的。</p>
<img src="/2024/06/06/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/render-flow.png" class="" title="render-flow">
<p>但是渲染流不支持拓展和修改，除非自己修改引擎代码。</p>
<h2 id="渲染组件-RenderComponent"><a href="#渲染组件-RenderComponent" class="headerlink" title="渲染组件 RenderComponent"></a>渲染组件 RenderComponent</h2><p>每帧执行一次渲染流，其中每个<code>RenderComponent</code>的具体要渲染什么，需要在<strong>渲染执行前</strong>确定下来。具体由各个<code>Assembler</code>处理，生成<code>RenderData</code>，如下图：</p>
<img src="/2024/06/06/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/render-component.png" class="" title="render-component">

<h2 id="合批"><a href="#合批" class="headerlink" title="合批"></a>合批</h2><p>引擎为了优化渲染效率，在实际渲染前加入了合批判断，以减少渲染次数。<br>合批的判断发生在渲染流的<code>render</code>步骤，可以简单理解为：如果为上次渲染组件的材质或分组和下次渲染的材质或分组不同，就会打断合批。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** render-flow.js ***/</span></span><br><span class="line">_proto.<span class="property">_render</span> = <span class="keyword">function</span> (<span class="params">node</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> comp = node.<span class="property">_renderComponent</span>;</span><br><span class="line"></span><br><span class="line">    comp.<span class="title function_">_checkBacth</span>(_batcher, node.<span class="property">_cullingMask</span>);</span><br><span class="line"></span><br><span class="line">    comp.<span class="property">_assembler</span>.<span class="title function_">fillBuffers</span>(comp, _batcher);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_next</span>.<span class="title function_">_func</span>(node);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** render-flow.js ***/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*** CCRenderComponent.js ***/</span></span><br><span class="line"><span class="title function_">_checkBacth</span> (renderer, cullingMask) &#123;</span><br><span class="line">    <span class="keyword">let</span> material = <span class="variable language_">this</span>.<span class="property">_materials</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 材质的哈希值不同，或者裁剪位码不同，打断合批</span></span><br><span class="line">    <span class="keyword">if</span> ((material &amp;&amp; material.<span class="title function_">getHash</span>() !== renderer.<span class="property">material</span>.<span class="title function_">getHash</span>()) ||</span><br><span class="line">        renderer.<span class="property">cullingMask</span> !== cullingMask) &#123;</span><br><span class="line">        renderer.<span class="title function_">_flush</span>();</span><br><span class="line"></span><br><span class="line">        renderer.<span class="property">node</span> = material.<span class="title function_">getDefine</span>(<span class="string">&#x27;CC_USE_MODEL&#x27;</span>) ? <span class="variable language_">this</span>.<span class="property">node</span> : renderer.<span class="property">_dummyNode</span>;</span><br><span class="line">        renderer.<span class="property">material</span> = material;</span><br><span class="line">        renderer.<span class="property">cullingMask</span> = cullingMask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*** CCRenderComponent.js ***/</span></span><br></pre></td></tr></table></figure>

<p>而渲染遍历节点的顺序是深度优先，最常见的情况是渲染节点的纹理不同，导致合批被打断。<br>根据引擎合批的特点，尽量减少合批被打断的次数，有如下思路：</p>
<ol>
<li>保持材质<code>Material</code>不变，将需要渲染的图片合并到一张纹理<code>texture</code>上：动态合图、静态图集</li>
<li>修改材质<code>Material</code>，接收并处理多个纹理<code>texture</code>：多纹理材质</li>
<li>自定义渲染流程，默认遍历节点的方式是深度优先，某些情况下修改遍历方式，可以大幅减少合批被打断的次数，例如：用层序遍历的方式渲染列表。</li>
</ol>
<h1 id="修改渲染流"><a href="#修改渲染流" class="headerlink" title="修改渲染流"></a>修改渲染流</h1><p>修改渲染流，主要是为了解决引擎渲染流的两种缺陷：</p>
<ol>
<li>渲染流不支持拓展，无法实现特殊渲染需求，例如：共享节点渲染。</li>
<li>渲染的遍历方式不支持修改，只能使用深度优先，在遇到特殊渲染需求时，合批容易被打断导致 DrawCall 增加，例如：列表渲染。</li>
</ol>
<h2 id="修改渲染遍历顺序"><a href="#修改渲染遍历顺序" class="headerlink" title="修改渲染遍历顺序"></a>修改渲染遍历顺序</h2><p>这里提供一种不用修改引擎实现修改渲染的遍历顺序的方案。<br>修改节点的<code>renderFlag</code>，跳过遍历子节点的<code>children</code>阶段，放到自定义<code>Assembler</code>中的渲染流后渲染<code>postRender</code>阶段时再自己实现自定义的遍历顺序，这样做的好处是可以不用修改引擎。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Assembler核心处理代码</span></span><br><span class="line"><span class="title function_">fillBuffers</span>(<span class="params">comp, renderer</span>)&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> c <span class="keyword">of</span> node.<span class="property">children</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (needOrder) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!nodeOrderRecord[c.<span class="property">name</span>]) &#123;</span><br><span class="line">                nodeOrderRecord[c.<span class="property">name</span>] = nodeOrder++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!c.<span class="property">_activeInHierarchy</span> || c.<span class="property">_opacity</span> === <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        gtRenderFlag = c.<span class="property">_renderFlag</span> &amp; <span class="variable constant_">RENDER_MASK</span>;</span><br><span class="line">        <span class="keyword">if</span> (gtRenderFlag &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 移除子节点的renderFlag，使renderFlow不执行它的RENDER函数</span></span><br><span class="line">            c[<span class="string">&quot;__gtRenderFlag&quot;</span>] = gtRenderFlag;</span><br><span class="line">            c.<span class="property">_renderFlag</span> &amp;= ~gtRenderFlag;</span><br><span class="line">            <span class="keyword">let</span> <span class="attr">key</span>: <span class="built_in">string</span>;</span><br><span class="line">            <span class="comment">// 内部策略策略</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> strategy <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">_innerStrategies</span>) &#123;</span><br><span class="line">                key = <span class="title function_">strategy</span>(c);</span><br><span class="line">                <span class="keyword">if</span> (key) <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 外部策略策略</span></span><br><span class="line">            <span class="keyword">if</span> (!key) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> strategy <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">_renderComp</span>.<span class="property">strategies</span>) &#123;</span><br><span class="line">                    key = <span class="title function_">strategy</span>(c);</span><br><span class="line">                    <span class="keyword">if</span> (key) <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!key) key = <span class="title class_">LayerKey</span>.<span class="property">None</span>;</span><br><span class="line">            <span class="comment">// 根据策略给节点分层，后渲染时按分层渲染</span></span><br><span class="line">            <span class="keyword">if</span> (key.<span class="title function_">includes</span>(<span class="string">&quot;Top&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_topLayerMap</span>[key]) &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">_topLayerMap</span>[key] = [];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">_topLayerMap</span>[key].<span class="title function_">push</span>(c);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!layerMap[key]) &#123;</span><br><span class="line">                    layerMap[key] = [];</span><br><span class="line">                &#125;</span><br><span class="line">                layerMap[key].<span class="title function_">push</span>(c);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 逐层传递父节点的dirtyFlag</span></span><br><span class="line">        c[<span class="string">&quot;__gtDirtyFlag&quot;</span>] = dirtyFlag | (c.<span class="property">_renderFlag</span> &amp; <span class="variable constant_">PROP_DIRTY_MASK</span>);</span><br><span class="line">        queue.<span class="title function_">push</span>(c);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">postFillBuffers</span>(<span class="params">comp, renderer</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 按层级遍历所有子节点</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> layer <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">_layers</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (layer.<span class="property">length</span> == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> c <span class="keyword">of</span> layer) &#123;</span><br><span class="line">            gtRenderFlag = c[<span class="string">&quot;__gtRenderFlag&quot;</span>];</span><br><span class="line">            gtDirtyFlag = c[<span class="string">&quot;__gtDirtyFlag&quot;</span>];</span><br><span class="line">            <span class="comment">// 设置worldMatDirty，在引擎默认fillBuffers()中该变量用于判断是否更新世界坐标</span></span><br><span class="line">            renderer.<span class="property">worldMatDirty</span> = gtDirtyFlag &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">            c.<span class="property">_renderFlag</span> |= gtRenderFlag;</span><br><span class="line">            <span class="comment">// 调用子节点RenderFlow的剩余部分</span></span><br><span class="line">            cc.<span class="property">RenderFlow</span>.<span class="property">flows</span>[gtRenderFlag].<span class="title function_">_func</span>(c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于论坛大佬的<a target="_blank" rel="noopener" href="https://forum.cocos.org/t/postrender-demo/95201">层序渲染</a>思路改进而实现。</p>
<h2 id="修改-拓展渲染流"><a href="#修改-拓展渲染流" class="headerlink" title="修改&#x2F;拓展渲染流"></a>修改&#x2F;拓展渲染流</h2><p>修改<code>render-flow.js</code>下的代码，拓展渲染流，例如：在渲染完节点后加入自定义逻辑。</p>

      
    </div>
      
        
        
      
      <div class="clearfix"></div>
      </footer>
  </div>
</article>





  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2024/03/04/psd转预制体/">psd转预制体</a></h1>
  

      
        <time datetime="2024-03-03T16:00:00.000Z">2024-03-04</time>
      
    </header>
    <div class="entry">
      
        <h1 id="psd转预制体"><a href="#psd转预制体" class="headerlink" title="psd转预制体"></a>psd转预制体</h1><h2 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h2><h3 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h3><p>在前端开发界面中，拼UI是必不可少的环节，而当遇到复杂界面时，拼UI的耗时会成倍增长，犯错的概率也会增加。</p>
<p>分析拼UI的工作流程，可以概括为：将美术生成的psd中摆放的图片，转移到cocos中变成预制体和图片资源。</p>
<p>容易看出，这个过程可以做自动化处理，于是引入psd转预制体插件。</p>
<p>初版需求如图：</p>
<img src="/2024/03/04/psd%E8%BD%AC%E9%A2%84%E5%88%B6%E4%BD%93/%E9%9C%80%E6%B1%82.jpg" class="" title="需求">

<p>后来考虑前端对组件的理解与美术的理解有差距，只需要美术对九宫格图片和翻转的图片做层级命名。</p>
<h3 id="插件介绍"><a href="#插件介绍" class="headerlink" title="插件介绍"></a>插件介绍</h3><p>基于ccc-tnt-psd2ui插件进行了二次开发的新版本，在插件原有基础上，增加了<strong>相似图片识别算法</strong>、<strong>图片压缩</strong>、<strong>富文本识别处理</strong>、<strong>九宫格识别的优化改进</strong>，以及一些bug修复，并且具有更高的稳定性。</p>
<p><a target="_blank" rel="noopener" href="https://gitee.com/onvia/ccc-tnt-psd2ui">原插件地址</a><br><a target="_blank" rel="noopener" href="https://forum.cocos.org/t/topic/151054">论坛地址</a></p>
<h3 id="功能描述"><a href="#功能描述" class="headerlink" title="功能描述"></a>功能描述</h3><p>将 psd 转为可以直接在 cocos 中使用的预制体，并导出图片资源。</p>
<p>前提是需要在 Photoshop 中根据文档做好图层的处理，给图层打标签。</p>
<p>美术同学把效果做好，我们只需要调整一下图层就可以了。</p>
<h3 id="大大提升了开发拼界面的效率"><a href="#大大提升了开发拼界面的效率" class="headerlink" title="大大提升了开发拼界面的效率"></a>大大提升了开发拼界面的效率</h3><p>大部分情况下，插件帮助开发完成80%拼界面的工作量，剩下20%只需要调整节点层级、锚点还有widget适配。</p>
<p>但是根据UI反馈，对层级命名可能会增加一些额外的工作量，主要体现在，九宫格标签上的数据需要额外处理才能获得。而且按目前版本，已导出过的九宫格图片，再次使用时仍需要加九宫格标签，对于内容繁多的界面可能会耗费更多时间。</p>
<h3 id="版本支持"><a href="#版本支持" class="headerlink" title="版本支持"></a>版本支持</h3><p>本插件开发和测试都基于 CocosCreator  <code>3.6.3</code> ，理论上可以支持<code>3.6.+</code>到<code>3.8.+</code>版本</p>
<p>核心功能支持CocosCreator  <code>2.x</code>，但操作界面需要另外适配</p>
<h2 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h2><h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图<img src="/2024/03/04/psd%E8%BD%AC%E9%A2%84%E5%88%B6%E4%BD%93/psd%E6%8F%92%E4%BB%B6%E6%B5%81%E7%A8%8B%E5%9B%BE.png" class="" title="psd插件流程图"></h3><h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h3><img src="/2024/03/04/psd%E8%BD%AC%E9%A2%84%E5%88%B6%E4%BD%93/psd%E6%8F%92%E4%BB%B6%E6%9E%B6%E6%9E%84%E5%9B%BE.png" class="" title="psd插件架构图">

<p>优势：核心功能在Node.js环境下运行，不依赖于特定的引擎版本，使得插件能够在不同版本的Cocos Creator上使用，甚至可以兼容不同操作系统。此外，在开发过程中，无需考虑引擎相关的细节，可以更专注于功能本身的开发和测试。</p>
<h2 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a>技术方案</h2><h3 id="1-psd读取库"><a href="#1-psd读取库" class="headerlink" title="1.psd读取库"></a>1.psd读取库</h3><p>在npm上筛选出两个知名度、质量、维护频率都比较高的库</p>
<img src="/2024/03/04/psd%E8%BD%AC%E9%A2%84%E5%88%B6%E4%BD%93/psd%E5%BA%93npm%E5%AF%B9%E6%AF%94.png" class="" title="psd库npm对比">

<img src="/2024/03/04/psd%E8%BD%AC%E9%A2%84%E5%88%B6%E4%BD%93/psd%E5%BA%93%E5%AF%B9%E6%AF%94.png" class="" title="psd库对比">

<p>对比发现，ag-psd优于psd.js。重点是ag-psd在图片操作方式上，支持canvas的API，因此可以实现图片相似度计算和九宫格切图导出。</p>
<h3 id="2-相似图片识别"><a href="#2-相似图片识别" class="headerlink" title="2.相似图片识别"></a>2.相似图片识别</h3><p>为什么要做相似图片识别？不同psd可能会用到相同的图片，但我们不希望项目中出现过多冗余的图片资源。</p>
<p>原插件的方案：根据图片的buffer生成md5值，相同md5的图片不再重复生成。</p>
<p>缺点：用md5识别重复图片过于严格，如果两张图片仅有一个不同像素，也会被认为是不同的图片。</p>
<p>改进方案：使用图片相似度算法，判断重复图片。</p>
<p>四种基础的图片相似度计算算法：<strong>平均哈希算法</strong>、<strong>感知哈希算法</strong>、<strong>颜色分布法</strong>、<strong>内容特征法</strong>。</p>
<p>先上链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904016686628877">https://juejin.cn/post/6844904016686628877</a></p>
<p>不再详细说明各种算法的实现，感兴趣的同学可以自行探索</p>
<p>最终采用<strong>感知哈希算法</strong>和<strong>颜色分布法</strong>相结合的方案，下面说明为什么要采用这两种算法。</p>
<h4 id="实际情况列举"><a href="#实际情况列举" class="headerlink" title="实际情况列举"></a>实际情况列举</h4><h5 id="1-比例不同"><a href="#1-比例不同" class="headerlink" title="1.比例不同"></a>1.比例不同</h5><img src="/2024/03/04/psd%E8%BD%AC%E9%A2%84%E5%88%B6%E4%BD%93/%E6%AF%94%E4%BE%8B%E4%B8%8D%E5%90%8C.png" class="" title="比例不同">

<p>对于比例不同的图片，可以看到不同的算法得出的相似度都比较高</p>
<h5 id="2-结构相同但颜色不同"><a href="#2-结构相同但颜色不同" class="headerlink" title="2.结构相同但颜色不同"></a>2.结构相同但颜色不同</h5><img src="/2024/03/04/psd%E8%BD%AC%E9%A2%84%E5%88%B6%E4%BD%93/%E7%BB%93%E6%9E%84%E7%9B%B8%E8%BF%91.png" class="" title="结构相近">

<p>结构相似度高，但颜色相似度为0</p>
<h5 id="3-颜色相似但结构不同"><a href="#3-颜色相似但结构不同" class="headerlink" title="3.颜色相似但结构不同"></a>3.颜色相似但结构不同</h5><img src="/2024/03/04/psd%E8%BD%AC%E9%A2%84%E5%88%B6%E4%BD%93/%E9%A2%9C%E8%89%B2%E7%9B%B8%E8%BF%91.png" class="" title="颜色相近">

<p>颜色相似度高，但结构相似度低</p>
<p>综上所述，判断两张图片是否具有较高的相似度，需要从颜色和结构两个角度考虑。</p>
<h4 id="耗时优化"><a href="#耗时优化" class="headerlink" title="耗时优化"></a>耗时优化</h4><p>实际使用中发现生成特征值耗时过长，定位到关键耗时函数，优化前代码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">memoizeCosines</span>(<span class="params">N, cosMap</span>) &#123;</span><br><span class="line">    cosMap = cosMap || &#123;&#125;;</span><br><span class="line">    cosMap[N] = <span class="keyword">new</span> <span class="title class_">Array</span>(N * N);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable constant_">PI_N</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / N;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> k = <span class="number">0</span>; k &lt; N; k++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> n = <span class="number">0</span>; n &lt; N; n++) &#123;</span><br><span class="line">            cosMap[N][n + (k * N)] = <span class="title class_">Math</span>.<span class="title function_">cos</span>(<span class="variable constant_">PI_N</span> * (n + <span class="number">0.5</span>) * k);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cosMap;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dct</span>(<span class="params">signal, scale = <span class="number">2</span></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> L = signal.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">let</span> cosMap = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!cosMap || !cosMap[L]) &#123;</span><br><span class="line">        cosMap = <span class="title function_">memoizeCosines</span>(L, cosMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> coefficients = signal.<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;);</span><br><span class="line">    <span class="keyword">return</span> coefficients.<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params">_, ix</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> scale * signal.<span class="title function_">reduce</span>(<span class="keyword">function</span> (<span class="params">prev, cur, index</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> prev + (cur * cosMap[L][index + (ix * L)]);</span><br><span class="line">        &#125;, <span class="number">0</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调试发现，dct中L的值是固定的，所以memoizeCosines调用后生成的cosMap也是一样的，于是马上想到将首次计算的结果储存起来，以便复用。这一步大概节省了一秒的时间。</p>
<p>接着代码分析，看到return后面跟着map再套reduce，感觉时间复杂度直接达到O(n²)，在实际调试中发现实际循环的次数达到了10万数量级。其实本质上就是两个循环嵌套，改写成for循环后，又能进一步优化耗时。原因是：JavaScript中的函数式编程，如：map、reduce、foreach等，使用起来方便又优雅，但是当执行次数的数量级过高时，耗时反而比简单的for循环更高，其中一个原因是每次执行都有额外的函数调用开销。</p>
<table>
<thead>
<tr>
<th></th>
<th>优化前平均耗时</th>
<th>优化后平均耗时</th>
</tr>
</thead>
<tbody><tr>
<td>生成一张图片的特征值</td>
<td>1.45s</td>
<td>0.37s</td>
</tr>
</tbody></table>
<p>虽然对单次生成特征值的耗时做了优化，但是当项目中图片数量级提升后，总体耗时也会变多。于是考虑用空间换时间的思路，将已生成过的特征值缓存起来。（缓存的更新依托于引擎的资源更新事件，没有实现在核心nodejs代码中）</p>
<h3 id="3-图片压缩"><a href="#3-图片压缩" class="headerlink" title="3.图片压缩"></a>3.图片压缩</h3><p>在插件运行中，图片先是被读取成buffer类型的变量，再导出成图片。可以在两个时机压缩图片，图片导出成文件后压缩，或者用压缩算法对buffer类型的变量进行处理。</p>
<p>本人偏好第二种方式，使用imagemin库可以将buffer作为输入，将图片压缩成png8格式，再写入文件。</p>
<h3 id="4-对比目录"><a href="#4-对比目录" class="headerlink" title="4.对比目录"></a>4.对比目录</h3><p>原插件的图片对比范围是项目下所有图片，但使用相似图片识别算法后，平均一张图片生成特征值需要0.37秒，如果仍对比全项目的图片会导致耗时过长。</p>
<p>考虑到耗时问题，支持开发者手动输入需要对比的路径，例如：通用图片资源、同模块下的图片资源。</p>
<h3 id="5-九宫格切图"><a href="#5-九宫格切图" class="headerlink" title="5.九宫格切图"></a>5.九宫格切图</h3><p>切图网格</p>
<img src="/2024/03/04/psd%E8%BD%AC%E9%A2%84%E5%88%B6%E4%BD%93/%E5%88%87%E5%9B%BE%E7%BD%91%E6%A0%BC.png" class="" title="切图网格">

<p>切图转换示意图</p>
<img src="/2024/03/04/psd%E8%BD%AC%E9%A2%84%E5%88%B6%E4%BD%93/%E5%88%87%E5%9B%BE%E8%BD%AC%E6%8D%A2.png" class="" title="切图转换">

<p>核心代码</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="title function_">split</span>(<span class="attr">_canvas</span>: canvas.<span class="property">Canvas</span>, <span class="attr">border</span>: <span class="title class_">Border</span>): canvas.<span class="property">Canvas</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">safeBorder</span>(_canvas, border);</span><br><span class="line">    <span class="keyword">let</span> cw = _canvas.<span class="property">width</span>;</span><br><span class="line">    <span class="keyword">let</span> ch = _canvas.<span class="property">height</span>;</span><br><span class="line">    <span class="keyword">let</span> space = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> left = border.<span class="property">l</span>;</span><br><span class="line">    <span class="keyword">let</span> right = border.<span class="property">r</span>;</span><br><span class="line">    <span class="keyword">let</span> top = border.<span class="property">t</span>;</span><br><span class="line">    <span class="keyword">let</span> bottom = border.<span class="property">b</span>;</span><br><span class="line">    <span class="keyword">if</span> (border.<span class="property">b</span> == <span class="number">0</span> &amp;&amp; border.<span class="property">t</span> == <span class="number">0</span> &amp;&amp; border.<span class="property">l</span> == <span class="number">0</span> &amp;&amp; border.<span class="property">r</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> _canvas;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (border.<span class="property">l</span> + border.<span class="property">r</span> &gt; cw + space) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Texture9Utils-&gt; 设置的九宫格 left， right 数据不合理，请重新设置`</span>);</span><br><span class="line">        <span class="keyword">return</span> _canvas;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (border.<span class="property">b</span> + border.<span class="property">t</span> &gt; ch + space) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Texture9Utils-&gt; 设置的九宫格 bottom， top 数据不合理，请重新设置`</span>);</span><br><span class="line">        <span class="keyword">return</span> _canvas;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> width = border.<span class="property">l</span> == <span class="number">0</span> &amp;&amp; border.<span class="property">r</span> == <span class="number">0</span> ? cw : <span class="title class_">Math</span>.<span class="title function_">min</span>(cw, border.<span class="property">l</span> + border.<span class="property">r</span> + space);</span><br><span class="line">    <span class="keyword">let</span> height = border.<span class="property">b</span> == <span class="number">0</span> &amp;&amp; border.<span class="property">t</span> == <span class="number">0</span> ? ch : <span class="title class_">Math</span>.<span class="title function_">min</span>(ch, border.<span class="property">b</span> + border.<span class="property">t</span> + space);</span><br><span class="line">    <span class="keyword">if</span>(border.<span class="property">l</span> == <span class="number">0</span> &amp;&amp; border.<span class="property">r</span> == <span class="number">0</span>)&#123;</span><br><span class="line">        left = cw;</span><br><span class="line">        right = cw;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(border.<span class="property">b</span> == <span class="number">0</span> &amp;&amp; border.<span class="property">t</span> == <span class="number">0</span>)&#123;</span><br><span class="line">        top = ch;</span><br><span class="line">        bottom = ch;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> newCanvas = canvas.<span class="title function_">createCanvas</span>(width, height);</span><br><span class="line">    <span class="keyword">let</span> ctx = newCanvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 左上</span></span><br><span class="line">    ctx.<span class="title function_">drawImage</span>(_canvas, <span class="number">0</span>, <span class="number">0</span>, left + space, top + space, <span class="number">0</span>, <span class="number">0</span>, left + space, top + space);</span><br><span class="line">    <span class="comment">// 左下</span></span><br><span class="line">    ctx.<span class="title function_">drawImage</span>(_canvas, <span class="number">0</span>, ch - bottom, left + space, bottom, <span class="number">0</span>, top + space, left + space, bottom);</span><br><span class="line">    <span class="comment">// 右上</span></span><br><span class="line">    ctx.<span class="title function_">drawImage</span>(_canvas, cw - right, <span class="number">0</span>, right, top + space, left + space, <span class="number">0</span>, right, top + space);</span><br><span class="line">    <span class="comment">// 右下</span></span><br><span class="line">    ctx.<span class="title function_">drawImage</span>(_canvas, cw - right, ch - bottom, right, bottom, left + space, top + space, right, bottom);</span><br><span class="line">    <span class="keyword">return</span> newCanvas;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-节点树序列化"><a href="#6-节点树序列化" class="headerlink" title="6.节点树序列化"></a>6.节点树序列化</h3><p>label组件序列化示例，通过@ccversion装饰器标记变量在不同版本下是否需要序列化。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@cctype</span>(<span class="string">&quot;cc.Label&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CCLabel</span> <span class="keyword">extends</span> <span class="title class_ inherited__">CCComponent</span>&#123;</span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">all</span>)</span><br><span class="line">    <span class="attr">_srcBlendFactor</span>: <span class="built_in">number</span> = <span class="number">770</span>; <span class="comment">// 3.4.x = 2</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">all</span>)</span><br><span class="line">    <span class="attr">_dstBlendFactor</span>: <span class="built_in">number</span> = <span class="number">771</span>; <span class="comment">// 3.4.x = 4</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">all</span>)</span><br><span class="line">    <span class="attr">_string</span>: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">all</span>)</span><br><span class="line">    <span class="attr">_fontSize</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">all</span>)</span><br><span class="line">    <span class="attr">_lineHeight</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">all</span>)</span><br><span class="line">    <span class="attr">_enableWrapText</span>: <span class="built_in">boolean</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">all</span>)</span><br><span class="line">    <span class="attr">_isSystemFontUsed</span>: <span class="built_in">boolean</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">all</span>)</span><br><span class="line">    <span class="attr">_spacingX</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">all</span>)</span><br><span class="line">    <span class="attr">_underlineHeight</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v249</span>)</span><br><span class="line">    <span class="attr">_materials</span>: <span class="title class_">CCUUIDObject</span>[] = [];</span><br><span class="line">    <span class="comment">// 2.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v249</span>)</span><br><span class="line">    <span class="attr">_N$string</span>: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">// 2.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v249</span>)</span><br><span class="line">    <span class="attr">_N$file</span>: <span class="built_in">any</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 2.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v249</span>)</span><br><span class="line">    <span class="attr">_batchAsBitmap</span>: <span class="built_in">boolean</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// 2.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v249</span>)</span><br><span class="line">    <span class="attr">_styleFlags</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 2.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v249</span>)</span><br><span class="line">    <span class="attr">_N$horizontalAlign</span>: <span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 2.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v249</span>)</span><br><span class="line">    <span class="attr">_N$verticalAlign</span>: <span class="built_in">number</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 2.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v249</span>)</span><br><span class="line">    <span class="attr">_N$fontFamily</span>: <span class="built_in">string</span> = <span class="string">&quot;Arial&quot;</span>;</span><br><span class="line">    <span class="comment">// 2.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v249</span>)</span><br><span class="line">    <span class="attr">_N$overflow</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 2.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v249</span>)</span><br><span class="line">    <span class="attr">_N$cacheMode</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v342</span>)</span><br><span class="line">    <span class="attr">_visFlags</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 3.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v342</span>)</span><br><span class="line">    <span class="attr">_customMaterial</span>: <span class="built_in">any</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 3.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v342</span>)</span><br><span class="line">    <span class="attr">_color</span>: <span class="title class_">CCColor</span> = <span class="keyword">new</span> <span class="title class_">CCColor</span>(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>);</span><br><span class="line">    <span class="comment">// 3.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v342</span>)</span><br><span class="line">    <span class="attr">_overflow</span>: <span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// // 3.4.x</span></span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v342</span>)</span><br><span class="line">    _cacheMode = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v342</span>)</span><br><span class="line">    _horizontalAlign = <span class="number">1</span>;</span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v342</span>)</span><br><span class="line">    _verticalAlign = <span class="number">1</span>;</span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v342</span>)</span><br><span class="line">    _actualFontSize = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v342</span>)</span><br><span class="line">    _isItalic = <span class="literal">false</span>;</span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v342</span>)</span><br><span class="line">    _isBold = <span class="literal">false</span>;</span><br><span class="line">    <span class="meta">@ccversion</span>(<span class="title class_">EditorVersion</span>.<span class="property">v342</span>)</span><br><span class="line">    _isUnderline = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">updateWithLayer</span>(<span class="params"><span class="attr">psdLayer</span>: <span class="title class_">PsdText</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_fontSize</span> = psdLayer.<span class="property">fontSize</span>;</span><br><span class="line">        <span class="comment">// this._actualFontSize = this._fontSize;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_string</span> = <span class="variable language_">this</span>.<span class="property">_N$string</span> = psdLayer.<span class="property">text</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_lineHeight</span> = <span class="variable language_">this</span>.<span class="property">_fontSize</span> + config.<span class="property">textLineHeightOffset</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(config.<span class="property">editorVersion</span> &gt;= <span class="title class_">EditorVersion</span>.<span class="property">v342</span>)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_srcBlendFactor</span> = <span class="number">2</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_dstBlendFactor</span> = <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过验证，这一部分代码生成的prefab比较完整，可以当作一个完整的prefab生成模块，复用到其他插件。</p>
<h2 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h2><h3 id="工具特性"><a href="#工具特性" class="headerlink" title="工具特性"></a>工具特性</h3><p>使用特征值判断图像相似度，相似度较高的图像会识别为相同的图像，并且只会导出一张图片<br>如果是相同的图像但是大小不同，则可以使用 <code>bind</code> 功能进行绑定（不使用<code>bind</code>也可以自动识别，但不保证一定准确），具体使用可以字段说明和示例文件<br>如果是相同的图像但是有翻转，则可以使用 <code>flip</code> 功能进行绑定，具体使用可以字段说明和示例文件<br>如果是相同的图像但是旋转角度不同，则会导出多张旋转角度不同的图片，需要手动去 Cocos 中处理旋转</p>
<p>工具在导出资源的时候会将图片的特征值写入到缓存文件，当其他 psd 有相同特征值的图片时，不再导出图片<br>美术导出的图片可能与本工具导出的图片有细微差别，所以当出现相同的图片时请考虑这种情况</p>
<h3 id="特别注意"><a href="#特别注意" class="headerlink" title="特别注意"></a>特别注意</h3><p>工具只适用于新界面的首次导出，如果界面已经开发到一定程度，但是因需求变化，界面结构发生变化，想重新导出，需要谨慎使用。<br>如果导出之后缺少某些图片，请确认是否写入了缓存，写入缓存的不会重新导出。<br>如果出现资源丢失的情况，请确认在项目中是否被手动删除了。  </p>
<p>原插件提示：不建议将输出目录设置为 项目的 <code>assets</code> 文件夹下，可能由于编辑器的权限导致不可预期的错误。<br>实际使用中：并没有遇到太严重的错误</p>
<h3 id="Mac-用户请注意！！！！"><a href="#Mac-用户请注意！！！！" class="headerlink" title="Mac 用户请注意！！！！"></a>Mac 用户请注意！！！！</h3><p>Mac 下首次使用需要先执行根目录下的 <code>install_depends.sh</code> 安装 <code>canvas</code> 所需要的依赖，如果安装错误 请根据 <code>https://github.com/Automattic/node-canvas</code> 手动安装</p>
<p>如果出现 <code>Bad CPU type in executable canvas</code> 的报错，按照下面步骤进行处理。</p>
<ol>
<li>卸载 canvas ，在这个插件目录下执行 <code>npm uninstall canvas</code></li>
<li>重新安装 canvas，<code>npm i canvas</code></li>
</ol>
<p>如果你 NodeJS 是 16.14.0 版本 ,执行完上面命令之后重新打开插件应该就可以了。<br>如果 NodeJS 不是16.14.0 版本，可以使用 nvm 安装一下 16.14.0。<br>或者你可以在执行完上面的命令之后，修改一下 libs&#x2F;psd2ui&#x2F;command.sh<br>里面 <code>$(dirname $(dirname $cur_dir))/bin/node</code> 删除前面的 <code>$(dirname $(dirname $cur_dir))/bin/</code> 只保留 node</p>
<h4 id="3-6-3版本界面说明"><a href="#3-6-3版本界面说明" class="headerlink" title="3.6.3版本界面说明"></a>3.6.3版本界面说明</h4><img src="/2024/03/04/psd%E8%BD%AC%E9%A2%84%E5%88%B6%E4%BD%93/%E7%95%8C%E9%9D%A2.png" class="" title="界面">

<ol>
<li>重置缓存： 清除原有缓存，重新导入</li>
<li>强制导出图片选项： 勾选后，即使已经进行缓存的资源同样会导出图片</li>
<li>只导出图片选项： 可以把此工具只当做是切图工具，同时会将文本图层的字号及颜色输出到txt文件</li>
<li>中文转拼音：最终导出无论是图片名还是节点名如果包含中文，都会转成拼音。</li>
<li>输出路径输入框： 可以直接导出到指定路径，如果没有填写，默认为 psd 同级目录</li>
<li>拖拽框区域：拖入 psd 文件夹或 psd 文件，也可以点击红框区域使用选择文件功能</li>
</ol>
<h3 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h3><p><a href="#Btn"> @Btn | @btn 按钮</a></p>
<p><a href="#ProgressBar"> @ProgressBar | @progressBar 进度条</a></p>
<p><a href="#Toggle"> @Toggle | @toggle 选项按钮</a></p>
<p><a href="#png9"> @.9 九宫格</a></p>
<p><a href="#ar"> @ar 锚点</a></p>
<p><a href="#full"> @full 全屏</a></p>
<p><a href="#ignore"> @ignore | @ig 忽略导出图片和节点</a></p>
<p><a href="#ignorenode"> @ignorenode | @ignode 忽略导出节点</a></p>
<p><a href="#ignoreimg"> @ignoreimg | @igimg 忽略图片</a></p>
<p><a href="#img"> @img 图片选项</a></p>
<p><a href="#flip"> @flip 翻转图像</a></p>
<p><a href="#flipX"> @flipX 翻转图像 (flip 变种)</a></p>
<p><a href="#flipY"> @flipY 翻转图像 (flip 变种)</a></p>
<h3 id="移除"><a href="#移除" class="headerlink" title="移除"></a>移除</h3><p><del><a href="#size"> @size 尺寸</a></del></p>
<p><del><a href="#scale"> @scale 缩放</a></del></p>
<h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><p><a id="Btn"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@Btn || @btn</span><br><span class="line"></span><br><span class="line">作用图层: 所有图层</span><br></pre></td></tr></table></figure>

<p><a id="ProgressBar"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@ProgressBar || @progressBar</span><br><span class="line">作用图层: 组图层</span><br><span class="line"></span><br><span class="line">@bar </span><br><span class="line"></span><br><span class="line">bar 为 ProgressBar 的属性，类型为 Sprite</span><br><span class="line">作用图层: 图像图层</span><br></pre></td></tr></table></figure>

<p><a id="Toggle"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Toggle || @toggle</span><br><span class="line">作用图层: 组图层</span><br><span class="line"></span><br><span class="line">@check</span><br><span class="line"></span><br><span class="line">check 为 Toggle 的属性，类型为 Sprite</span><br><span class="line">作用图层: 图像图层</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Field"><a href="#Field" class="headerlink" title="Field"></a>Field</h3><p><a id="png9"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@.9&#123;l:0,r:0,b:0,t:0&#125;  </span><br><span class="line"></span><br><span class="line">九宫格</span><br><span class="line">作用图层: 图像图层</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">    l = left</span><br><span class="line">    r = right</span><br><span class="line">    b = bottom</span><br><span class="line">    t = top</span><br><span class="line">    ps: </span><br><span class="line">        l r 只填写其中一项，则为对称</span><br><span class="line">        b t 同上</span><br><span class="line">        不填写则默认为 0</span><br><span class="line">@ar&#123;x:0,y:0&#125;</span><br><span class="line"></span><br><span class="line">锚点</span><br><span class="line">作用图层: 所有图层</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">    参数都为可选</span><br><span class="line">    不填写则默认为 0.5</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><a id="full"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@full</span><br><span class="line"></span><br><span class="line">节点设置为全屏尺寸</span><br><span class="line">作用图层: 组图层</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a id="ignore"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@ignore</span><br><span class="line">@ig</span><br><span class="line"></span><br><span class="line">忽略导出图像和节点</span><br><span class="line">作用图层: 所有图层</span><br></pre></td></tr></table></figure>

<p><a id="ignorenode"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@ignorenode</span><br><span class="line">@ignode</span><br><span class="line"></span><br><span class="line">忽略导出节点</span><br><span class="line">作用图层: 所有图层</span><br></pre></td></tr></table></figure>

<p><a id="ignoreimg"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@ignoreimg</span><br><span class="line">@igimg</span><br><span class="line"></span><br><span class="line">忽略导出图像</span><br><span class="line">作用图层: 图像图层</span><br></pre></td></tr></table></figure>

<p><a id="img"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@img&#123;name:string,id:number,bind:number&#125;</span><br><span class="line"></span><br><span class="line">定制图片</span><br><span class="line">作用图层：图像图层</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">    id: number 可选 当前文档中图片唯一 id</span><br><span class="line">    name: string 可选 导出的图片名</span><br><span class="line">    bind: number 可选 绑定 图像 id</span><br></pre></td></tr></table></figure>

<p><a id="flip"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@flip&#123;bind: 0, x: 0, y: 0&#125;</span><br><span class="line"></span><br><span class="line">镜像图像</span><br><span class="line">作用图层：图像图层</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">    bind: number 必选 被绑定的图片 需要用  @img&#123;id:number&#125; 做标记</span><br><span class="line">    x: 0 | 1, 可选， 1 为 进行 x 方向镜像</span><br><span class="line">    y: 0 | 1, 可选， 1 为 进行 y 方向镜像</span><br><span class="line">    x,y 都缺省时，默认 x 方向镜像</span><br><span class="line"></span><br><span class="line">注意：</span><br><span class="line">    @flip 的图层不会导出图像</span><br></pre></td></tr></table></figure>

<p><a id="flipX"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@flipX&#123;bind: 0&#125;</span><br><span class="line"></span><br><span class="line">flip 的变种 x 方向镜像图像</span><br><span class="line">作用图层：图像图层</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">    bind: number 必选 被绑定的图片 需要用  @img&#123;id:number&#125; 做标记</span><br><span class="line"> </span><br><span class="line">注意：</span><br><span class="line">    @flipX 的图层不会导出图像</span><br></pre></td></tr></table></figure>

<p><a id="flipY"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@flipY&#123;bind: 0&#125;</span><br><span class="line"></span><br><span class="line">flip 的变种 y 方向镜像图像vv</span><br><span class="line">作用图层：图像图层</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">    bind: number 必选 被绑定的图片 需要用  @img&#123;id:number&#125; 做标记</span><br><span class="line"> </span><br><span class="line">注意：</span><br><span class="line">    @flipY 的图层不会导出图像</span><br></pre></td></tr></table></figure>

<hr>
<hr>
<hr>
<h3 id="移除-1"><a href="#移除-1" class="headerlink" title="移除"></a>移除</h3><p><a id="size"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@size&#123;w:100,h:100&#125;</span><br><span class="line"></span><br><span class="line">节点尺寸 非图片尺寸</span><br><span class="line">作用图层: 所有图层</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">    w?: 宽</span><br><span class="line">    h?: 高</span><br><span class="line">    只对填写的参数生效，未填写的则为计算到的值</span><br><span class="line">    无参数不生效</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p><a id="scale"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@scale&#123;x:1,y:1&#125;</span><br><span class="line"></span><br><span class="line">节点缩放</span><br><span class="line">作用图层: 所有图层</span><br><span class="line"></span><br><span class="line">参数：</span><br><span class="line">    x?: x 方向</span><br><span class="line">    y?: y 方向</span><br><span class="line">    只对填写的参数生效，未填写的则为 1 </span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<hr>
<hr>
<hr>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>​    多个字段可作用在同一个图层上，按需使用<br>​    为做到所见所得，移除手动设置 @size 和 @scale，修改为自动计算，使用方式为 <code>@img&#123;bind:目标id&#125;</code> <code>@flipX&#123;bind:目标id&#125;</code> <code>@flipY&#123;bind:目标id&#125;</code></p>
<h4 id="例如"><a href="#例如" class="headerlink" title="例如"></a>例如</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">节点名@Btn@img&#123;bind:1&#125;</span><br><span class="line"></span><br><span class="line">节点名@ar&#123;x:1,y:1&#125;@full@img&#123;name:bg&#125;</span><br></pre></td></tr></table></figure>


<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><h4 id="美术"><a href="#美术" class="headerlink" title="美术"></a>美术</h4><ul>
<li>智能图层  支持 </li>
<li>蒙版，形状这些图层需要栅格化，或转为智能图层使用  </li>
<li>图层样式<ul>
<li>颜色叠加： 文本图层支持，图像图层不支持</li>
<li>描边： 文本图层支持</li>
<li>其他图层样式不支持</li>
</ul>
</li>
</ul>
<p>工具会把 画布外的图像也导出成图片，需要美术将 画布外 不需要导出的图像处理掉</p>
<h4 id="程序配置"><a href="#程序配置" class="headerlink" title="程序配置"></a>程序配置</h4><p>如果想对指定组件进行统一定制，可以修改 <code>psd2ui/config/psd.config.json</code> 文件<br>key 为组件名，val 为 预制体参数，你可以对任意组件的任意属性进行定制</p>
<p>例如当你想在导出时默认使用指定字体：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cc2.4.x 可以配置为</span><br><span class="line">&#123;</span><br><span class="line">    &quot;cc.Label&quot;: &#123;</span><br><span class="line">        &quot;_N$file&quot;:&#123;</span><br><span class="line">            &quot;__uuid__&quot;: &quot;7ecfa26a-27ec-4e2c-9815-d7c4c744d53f&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;_isSystemFontUsed&quot;: false</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cc3.7.x 可以配置为</span><br><span class="line">&quot;cc.Label&quot;: &#123;</span><br><span class="line">    &quot;_font&quot;: &#123;</span><br><span class="line">        &quot;__uuid__&quot;: &quot;7ecfa26a-27ec-4e2c-9815-d7c4c744d53f&quot;,</span><br><span class="line">        &quot;__expectedType__&quot;: &quot;cc.TTFFont&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">    &quot;_isSystemFontUsed&quot;: false</span><br><span class="line">&#125;</span><br><span class="line">// 以上这些配置会覆盖正常的属性数据，没有其他属性不受影响。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 特殊配置</span><br><span class="line">&quot;textOffsetY&quot;:&#123;</span><br><span class="line">    &quot;default&quot;: 0,</span><br><span class="line">    &quot;36&quot;: 0</span><br><span class="line">&#125;,</span><br><span class="line">&quot;textLineHeightOffset&quot;: 0</span><br><span class="line"></span><br><span class="line">// textOffsetY:  Label节点 Y 偏移，当你使用了定制的字体的时候，可能在 PS 中与 CocosCreator 中表现不一致，可以使用这个参数进行处理，字号为 key，偏移量为值</span><br><span class="line"></span><br><span class="line">// textLineHeightOffset: Label节点行高增量，默认没有增量，行高默认为字体大小，当你想将行高统一高n个像素的时候可以使用这个配置</span><br><span class="line"></span><br><span class="line">以字号为 key ，偏移值 为 val</span><br><span class="line">如果没有配置 某些字号，则 使用 default 默认偏移值，如果没有配置 default， 偏移为 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="未经测试的部分"><a href="#未经测试的部分" class="headerlink" title="未经测试的部分"></a>未经测试的部分</h3><p>二次开发过程中，没有对输入为多个 psd 或含有多个 psd 文件的文件夹的情况做详细测试，可能会出现图片导出异常的情况</p>
<h3 id="PS脚本"><a href="#PS脚本" class="headerlink" title="PS脚本"></a>PS脚本</h3><p>这里提供了一个图层重命名的 PS 脚本，可以批量对图层进行命名  </p>
<p>使用方式有两种：</p>
<ol>
<li>将脚本放入 PhotoShop文件夹中的 <code>\Presets\Scripts</code> 文件夹下，然后在 <code>Photoshop左上角-&gt; 文件 -&gt; 脚本-&gt; PS脚本-图层重命名</code> 就行看到</li>
<li>脚本放在任意位置，然后在 <code>Photoshop左上角-&gt; 文件 -&gt; 脚本-&gt; 浏览</code> 在打开的选择文件弹窗选择找到我们的脚本</li>
</ol>
<p>然后根据需求填入参数就行了</p>
<p>脚本见：psd转预制体\PS脚本-图层重命名.jsx</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="为什么要基于ccc-tnt-psd2ui插件做二次开发？"><a href="#为什么要基于ccc-tnt-psd2ui插件做二次开发？" class="headerlink" title="为什么要基于ccc-tnt-psd2ui插件做二次开发？"></a>为什么要基于ccc-tnt-psd2ui插件做二次开发？</h3><p>其实一开始想法很多，可以选择的方式也很多，就没有选择直接开始撸代码。而是简单地做了下调研，发现cocos论坛一直以来都有对这个需求展开讨论，也有几个大大给出了方案，但没有出现普适性比较好的方案。最后选择在ccc-tnt-psd2ui插件基础上做二次开发，是因为看上了它的架构，核心代码具有很强的独立性，还有节点树的序列化方式也十分接近cocos引擎的序列化方式。</p>
<h3 id="后续优化方向"><a href="#后续优化方向" class="headerlink" title="后续优化方向"></a>后续优化方向</h3><ol>
<li>九宫格自动识别：在代码中自动识别可以用九宫格切图的图片，完全解放UI。（已实现）</li>
<li>优化图片相似度计算算法：在目前的算法下，如果将一张图片缩小超过0.5的比例，就无法判断和原图是同一张图片。</li>
</ol>

      
    </div>
      
        
        
      
      <div class="clearfix"></div>
      </footer>
  </div>
</article>





  <article class="post">
  <div class="post-content">
    <header>
      
  
    <h1 class="title"><a href="/2023/08/25/弹窗管理系统/">弹窗管理系统</a></h1>
  

      
        <time datetime="2023-08-24T16:00:00.000Z">2023-08-25</time>
      
    </header>
    <div class="entry">
      
        <h1 id="弹窗管理系统"><a href="#弹窗管理系统" class="headerlink" title="弹窗管理系统"></a>弹窗管理系统</h1><h3 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h3><p>在操作系统中，有一种著名的调度算法——多级反馈队列（Multi-level Feedback Queue，MLFQ）。该算法将任务按照优先级划分为多个队列，并通过不断地调整任务所在队列来实现动态调度。</p>
<p>在该算法中，新到来的任务会首先进入最高优先级队列。如果该任务执行完毕后，仍有其他任务等待执行，则该任务会被放入第二高优先级队列中等待调度。依此类推，每一个队列都拥有一个固定的时间片，当一个任务在当前队列的时间片耗尽后，它会被移动到下一个优先级队列中等待调度。</p>
<p>如果一个任务在低优先级队列中等待时间过长，系统将会将其移回到高优先级队列中重新调度。另外，该算法还可以设置不同队列之间的优先级差别、任务进入队列的规则等参数，以便更好地控制任务的执行顺序和时间分配。</p>
<style>.idjurrwmhoep{zoom: 33%;}</style><img src="/2023/08/25/%E5%BC%B9%E7%AA%97%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/MLFQ.jpg" class="idjurrwmhoep" alt="MLFQ">

<p>引入多级反馈队列，是因为后面即将提到的“多级队列”可以视为其简化版本，包含了多级调度的思想。</p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>本文提到的弹窗管理系统是一种用于管理游戏或应用程序中弹窗面板的系统。该系统可以帮助开发者更好地管理和控制弹窗面板的展示和行为，降低弹窗类需求的开发成本。</p>
<p>具体而言，弹窗管理系统包括以下功能：</p>
<ul>
<li><p>弹窗的创建、管理和删除；</p>
</li>
<li><p>根据游戏中的特定条件进行特定弹窗的投放；</p>
</li>
<li><p>通过<a href="#%E5%A4%9A%E7%BA%A7%E9%98%9F%E5%88%97">多级队列</a>的方式调度弹窗的优先级；</p>
</li>
</ul>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>目前的PJC5项目，在处理弹窗类需求时，普遍采取在业务内作单独处理的方式。但随着项目的迭代开发，弹窗类需求逐渐增多，如：登录弹首充、满足特定条件弹礼包、业务开放弹提示等。随之而来的问题是，弹窗之间出现了冲突，在不做特殊处理的情况下，会出现多个弹窗同时弹出的现象。</p>
<p>在弹窗需求数量不多时，在业务内部处理弹窗的做法并没有问题，但随着弹窗数量的增多，冲突的出现使得对弹窗的管理变得更加困难，为了处理冲突而做的特殊处理也会几何级增长。为了解决此问题，引入弹窗管理系统专门处理弹窗类需求。</p>
<h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><ol>
<li><strong>降低了因弹窗冲突处理导致的业务之间的耦合度</strong>：弹窗系统可以通过内部调度管理，处理不同业务弹窗之间的冲突、优先级等问题。因此，业务对应的弹窗仅需要与弹窗系统进行交互，而不需要考虑其他业务弹窗，降低了业务弹窗之间的耦合度。</li>
<li><strong>灵活控制弹窗，弹窗是否弹出由系统和业务共同控制</strong>：系统负责调度层面的控制，具体弹窗是否弹出仍由具体业务负责。换句话说，弹窗系统负责弹窗的粗粒度控制，业务负责细粒度控制。</li>
<li><strong>具有良好的可拓展性，支持在任意条件任意场景中投放弹窗</strong>：弹窗系统采用触发器控制弹窗的投放时机，开发者可以根据需求自行拓展自定义的触发器，以控制弹窗投放。</li>
<li><strong>可以作为通用模块，跨项目使用</strong></li>
</ol>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>弹窗系统从结构上可以分为两部分：触发器和多级队列。触发器（Trigger）用于确定弹窗的弹出时机，根据实际使用情况，派生出不同的触发器（TriggerA、TriggerB）；多级队列用于调度和管理弹窗，每个队列管理者（PopUpListController）都负责多个弹窗（PopUpElement），根据实际使用情况，派生出多种不同的弹窗，常见的有面板类弹窗（PopUpPanelElement）、自定义弹窗（PopUpDiyElement）。</p>
<img src="/2023/08/25/%E5%BC%B9%E7%AA%97%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/%E7%B1%BB%E5%9B%BE.png" class="" title="类图">

<h4 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h4><p>触发器模式（Trigger Pattern）是一种常见的编程模式，用于处理异步事件。在该模式中，事件分为两个部分：触发器和处理程序。当触发器满足一定条件时，就会触发相应的处理程序，进行后续操作。</p>
<p>触发器模式可以视为观察者模式的一种优化版本。相比于普通的观察者模式，触发器模式能够将事件发送者和事件接收者解耦合，从而在程序开发中减少各组件之间的依赖关系，使得代码更加模块化，可维护性和可扩展性更强。</p>
<p>弹窗系统使用触发器模式来确定弹窗的弹出时机。系统通过触发器来检测游戏状态，当触发器检测到满足特定条件时，就会触发相应的弹窗投放，进行弹窗的展示。</p>
<p>例如：实现游戏中常见的升级弹窗，弹窗系统会设置一个触发器，每当玩家升级后，会通知弹窗系统，弹出升级成功的弹窗。</p>
<h4 id="多级队列"><a href="#多级队列" class="headerlink" title="多级队列"></a>多级队列</h4><img src="/2023/08/25/%E5%BC%B9%E7%AA%97%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/image-20230525162258488.png" class="" title="image-20230525162258488">

<p>多级队列是一种用于弹窗调度的数据结构，包含两种优先级队列：一级队列只有一个，包含多个二级队列；每个二级队列具有优先级，包含多个弹窗，同时对应一个触发器；每个弹窗也有对应的优先级。当一个弹窗关闭后，会根据多级队列，弹出下一个弹窗。</p>
<h5 id="注册弹窗流程"><a href="#注册弹窗流程" class="headerlink" title="注册弹窗流程"></a>注册弹窗流程</h5><img src="/2023/08/25/%E5%BC%B9%E7%AA%97%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/image-20230525162216241.png" class="" title="image-20230525162216241">

<p>首先，弹窗系统根据弹窗对应的触发类型（即触发器类型），将弹窗push进入对应的二级队列；然后，二级队列再根据弹窗的优先级进行排序；最后，二级队列将等待对应触发器的触发。</p>
<h5 id="触发器触发流程"><a href="#触发器触发流程" class="headerlink" title="触发器触发流程"></a>触发器触发流程</h5><img src="/2023/08/25/%E5%BC%B9%E7%AA%97%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/image-20230525162230400.png" class="" title="image-20230525162230400">

<p>二级队列的触发器触发后，弹窗系统会将二级队列作为一个元素加入一级队列中，并进行排序。每当一级队列中有元素时，弹窗系统都会按照优先级，逐个弹出弹窗。</p>
<p>当一个二级队列中的弹窗都完成弹出后，会被暂时移出一级队列，直到下一次触发器触发且二级队列中有弹窗才会重新进入一级队列。</p>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>玩家升到五十级，【玩家升级触发器】满足条件，【二级队列a】被加入【一级队列】。同时后端判断玩家满足条件，推送了一个礼包信息，【礼包触发器】满足条件，【二级队列b】也被加入【一级队列】。此时按照优先级，先弹出【二级队列a】中的【升级成功弹窗】，等玩家关闭【升级成功弹窗】后，再弹出【礼包弹窗】。</p>
<img src="/2023/08/25/%E5%BC%B9%E7%AA%97%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/image-20230525163458872.png" class="" title="image-20230525163458872">

<h3 id="业务弹窗注册方式"><a href="#业务弹窗注册方式" class="headerlink" title="业务弹窗注册方式"></a>业务弹窗注册方式</h3><p>向弹窗系统注册一个弹窗，业务需要明确弹窗的注册时机、触发类型以及弹出权限。</p>
<ul>
<li><p><strong>注册时机</strong></p>
<p>弹窗的注册时机应该在预期的弹出时机之前，换句话说，在触发器条件满足之前，弹窗应该已经完成注册。</p>
</li>
<li><p><strong>触发类型</strong></p>
<p>业务应该明确弹窗的触发类型，即弹窗应该由哪个触发器触发。</p>
</li>
<li><p><strong>弹出权限</strong></p>
<p>业务需要控制弹窗的实际弹出权限，例如：当业务没开放时不弹出、每天只弹出一次等，需要具体业务根据实际情况做判断。</p>
</li>
</ul>
<p>综上所述，<strong>触发类型</strong>和<strong>弹出权限</strong>共同控制弹窗是否弹出，即两者都满足时弹窗才能弹出。区别在于触发类型是粗粒度控制（所有业务都由多级队列统一调度），而弹出权限是细粒度控制（不同业务根据具体条件做限制）。</p>
<h3 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h3><p>本系统仅实现了基础框架，根据项目的区别、需求的变化，还有很多迭代优化空间。在此列举以下迭代优化的方向和思路：</p>
<ol>
<li><p>加入生命周期回调</p>
<p>可以在弹窗弹出前、弹窗弹出后、二级队列完成后等时机加上生命周期回调，以满足更多需求。</p>
</li>
<li><p>调度方式优化</p>
<p>多级队列的调度方式可能存在性能瓶颈，根据实际项目情况，可以优化其实现方式，或者采用更高效的调度方式。</p>
</li>
<li><p>配置驱动</p>
<p>如果项目中业务弹窗的权限控制具有明显的通用规则，可以考虑用配置驱动的方式，将弹窗权限控制集成到弹窗系统中。</p>
</li>
<li><p>错误处理</p>
<p>弹窗系统应该考虑到错误分支的处理。因为系统本身与多个业务耦合，影响范围比较大，如果某个弹窗在某个环节报错了，可能会导致后续弹窗无法弹出或游戏卡死。一种解决方案是，在强流程上使用try-catch捕获报错，并强制关闭报错的弹窗。</p>
</li>
</ol>

      
    </div>
      
        
        
      
      <div class="clearfix"></div>
      </footer>
  </div>
</article>






<nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:fr0zen-sh1t.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">最新文章</h3>
  <ul class="entry">
    
      <li>
        <a href="/2024/12/15/大型项目预览卡顿解决方案/">大型项目预览卡顿解决方案</a>
      </li>
    
      <li>
        <a href="/2024/08/08/Label合图/">Label合图</a>
      </li>
    
      <li>
        <a href="/2024/06/06/自定义渲染流程/">自定义渲染流程</a>
      </li>
    
      <li>
        <a href="/2024/03/04/psd转预制体/">psd转预制体</a>
      </li>
    
      <li>
        <a href="/2023/08/25/弹窗管理系统/">弹窗管理系统</a>
      </li>
    
  </ul>
</div>


  

  
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2025 Fr0zen
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



</body>
</html>

